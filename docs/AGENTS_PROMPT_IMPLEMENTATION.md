# 🚀 Agent Prompt 优化 - 快速实施指南

## 核心思路
将五大思维模型从**隐式**变成**显式**的 Prompt 指令，让每个 Agent 都：
1. ✅ 知道自己在评估什么模型
2. ✅ 有明确的评分机制（0-10 分）
3. ✅ 理解与其他 Agent 的协同关系

---

## 🎯 三个实施阶段

### Phase 1️⃣：显式化基础（3-5 天）
**目标：** 让每个 Agent 输出 0-10 的评分

#### 需要改动的 5 个文件

| 优先级 | Agent | 文件 | 工作量 | 难度 |
|-------|-------|------|-------|------|
| 1 | Market Analyst | `market_analyst.py` | 2-3h | ⭐ 低 |
| 2 | News Analyst | `news_analyst.py` | 2-3h | ⭐ 低 |
| 3 | Bull Researcher | `bull_researcher.py` | 3-4h | ⭐⭐ 中 |
| 4 | Bear Researcher | `bear_researcher.py` | 3-4h | ⭐⭐ 中 |
| 5 | Fundamentals Analyst | `fundamentals_analyst.py` | 4-5h | ⭐⭐ 中 |

**总耗时：** 14-19 小时（1.5-2 个开发日）

---

### Phase 2️⃣：集成到 Risk Manager（2-3 天）
**目标：** Risk Manager 接收 5 个评分，计算加权平均

#### 需要改动的文件
- `risk_manager.py` - 解析 5 个评分，计算加权决策
- `trading_graph.py` - 确保评分数据正确传递

**总耗时：** 6-8 小时（0.75-1 个开发日）

---

### Phase 3️⃣：学习系统（3-5 天）
**目标：** 追踪每个模型的准确率，动态调整权重

#### 需要改动的文件
- `memory.py` - 添加模型准确率追踪
- `reflection.py` - 记录预测 vs 实际结果
- `risk_manager.py` - 应用动态权重

**总耗时：** 12-16 小时（1.5-2 个开发日）

---

## 📋 Phase 1 详细改动清单

### Step 1.1：Market Analyst（0.5-1 天）

**当前状态：** ✓ 有指标分析，✗ 缺少背景验证和评分

**改动内容：**

```python
# 添加到 system_message 中

# 1. 在开头添加模型声明
"""
🎯 你的角色：市场分析员
你负责评估 MODEL 1：信号 vs 背景的二阶思维
核心问题："这个技术信号在这个背景下真的可信吗？"
"""

# 2. 在指标分析后添加背景检查
"""
### 背景验证（新增）

分析这 5 个背景因素：
1. 公司周期 - 增长期/成熟期/衰退期？
2. 价格位置 - 距离 200SMA 多远？
3. 竞争态势 - 竞争对手在做什么？
4. 基本面 - 利润率在改善还是恶化？
5. 情绪阶段 - 市场情绪极度乐观还是冷淡？
"""

# 3. 在报告最后添加评分
"""
### 信号可信度评分（0-10分）

计算方法：
- 指标一致性：3-5个一致=5分，6-8个=7分
- 背景支持：+3分完全支持，+1分部分，-2分反对
- 最终评分 = 基分 + 背景修正

输出格式：
**信号可信度评分：__ /10**
- 指标一致性：_/10
- 背景支持度：_/10  
- 综合评分：_/10
"""
```

**具体修改：**
- [ ] 在 system_message 顶部添加"模型1"声明
- [ ] 在指标分析后的 Step 4 添加背景验证逻辑
- [ ] 在报告最后添加评分计算和输出

---

### Step 1.2：News Analyst（0.5-1 天）

**当前状态：** ✓ 有新闻分析，✗ 缺少峰值检测和评分

**改动内容：**

```python
# 添加到 system_message 中

# 1. 在开头添加模型声明
"""
🎯 你的角色：新闻与情绪分析员
你负责评估 MODEL 4：叙事衰减与情绪峰值
核心问题："市场对这个故事的热情是增长/稳定/衰减？情绪是否在峰值？"
"""

# 2. 添加情绪峰值检测
"""
### 情绪峰值检测（新增关键功能）

检查以下 6 个条件，满足 ≥3 个 = 峰值出现：

1. 新闻热度在历史高位（过去4周新闻数 > 历史75分位）
2. 社交媒体情绪极度乐观（看多声音 > 85%）
3. 情绪表述极端化（充满"革命""改变世界"言辞）
4. 价格创新高且涨幅过大（最近1月涨幅 > 20%）
5. 媒体预期过度（价格目标涨幅 > 100%）
6. 散户参与爆炸式增长（Reddit提及数激增）

输出：
⚠️ 情绪峰值检测：YES/NO
风险等级：低/中/高
"""

# 3. 添加叙事生命周期分析
"""
### 叙事生命周期

当前阶段：初期/增长/高位/衰减/底部
从峰值开始已经多久：__ 天/周
预计发展方向：继续衰减/止跌/反弹
"""

# 4. 添加评分
"""
### 情绪评分（0-10分）

基础分：总体情绪倾向
- 极度乐观 (90%+ 看多) → 8分
- 乐观 (70-90%) → 6分
- 中立 (40-60%) → 5分
- 悲观 (20-40%) → 3分
- 极度悲观 (< 20%) → 1分

调整：
- 峰值风险 → -2分
- 提及频率↑ → +2分
- 提及频率↓ → -2分

最终评分：__/10
"""
```

**具体修改：**
- [ ] 在 system_message 顶部添加"模型4"声明
- [ ] 添加峰值检测逻辑（6个条件检查）
- [ ] 添加叙事生命周期分析
- [ ] 在报告最后添加 0-10 评分

---

### Step 1.3：Bull Researcher（0.75-1.5 天）

**当前状态：** ✓ 有辩论框架，✗ 缺少假设链和概率估计

**改动内容：**

```python
# 在 system_message 中添加

# 1. 模型声明和假设链概念
"""
🎯 你的角色：看涨研究员（Bull Analyst）
你负责评估 MODEL 5：假设链强度

核心任务：
1. 列出投资论文的所有假设
2. 估计每个假设的概率（0-100%）
3. 计算综合概率
4. 评估论文的强度
"""

# 2. 假设链构建指导
"""
### 构建你的假设链

典型假设应包括：

假设1：业务基础 - 产品/服务被市场接受，有足够需求
  你的概率估计：__% （如何估计？考虑管理层历史、技术难度、外部风险）

假设2：增长潜力 - 市场会快速增长，公司能赢得份额
  你的概率估计：__% 

假设3：财务路径 - 公司会实现盈利，利润率健康
  你的概率估计：__%

假设4：市场认可 - 市场会重新定价，PE倍数会扩张
  你的概率估计：__%

（可选）假设5：竞争位置 - 不被竞争对手超越
  你的概率估计：__%

综合概率 = 假设1% × 假设2% × 假设3% × 假设4%
        = __%
"""

# 3. 评分机制
"""
### 假设链强度评分（0-10分）

基础分：综合概率
- > 50% → 7分（论文很强）
- 30-50% → 5分（论文中等）
- 10-30% → 3分（论文较弱）
- < 10% → 1分（论文很弱）

加分：
+ 有多条独立价值驱动 → +1分
+ 管理层执行历史好 → +1分
+ 市场环境有利 → +1分

最终评分：__/10
"""

# 4. 风险应对
"""
### 风险应对计划

对每个假设，说明"万一失败怎么办"：
- 如果假设1失败 → 我们还有什么支持？
- 如果假设2失败 → 利润还能实现吗？
- 备选方案？
"""
```

**具体修改：**
- [ ] 在 prompt 开头添加"模型5"声明和假设链概念
- [ ] 加入假设列表和概率估计的明确指导
- [ ] 添加 0-10 评分机制
- [ ] 加入风险应对计划部分

---

### Step 1.4：Bear Researcher（0.75-1.5 天）

**当前状态：** ✓ 有辩论框架，✗ 缺少假设质疑和脆弱性评分

**改动内容：**

```python
# 在 system_message 中添加

# 1. 模型声明
"""
🎯 你的角色：看空研究员（Bear Analyst）
你负责质疑 MODEL 5：假设链脆弱性

核心任务：
1. 审视 Bull 提出的每个假设
2. 质疑每个假设的概率
3. 指出最脆弱的假设
4. 评估假设链的脆弱程度
"""

# 2. 假设质疑方法
"""
### 如何质疑假设

不是找新信息，而是对 Bull 的概率估计提出质疑：

方法1 - 历史数据：
  "类似项目的历史成功率是多少？"
  例：电动车商业化延迟 2-4 年

方法2 - 执行难度：
  "这需要解决的技术难题有多大？"
  例：L5 自动驾驶比 L4 难度大 10 倍

方法3 - 外部风险：
  "什么外部因素会摧毁假设？"
  例：监管突然禁止、竞争对手抢先

方法4 - 管理层信誉：
  "管理层过去的承诺都实现了吗？"
  例：CEO 说 2023 上市，实际 2024

修正后概率 = Bull 的概率 × 可信度系数
"""

# 3. 假设链脆弱性评分
"""
### 假设链脆弱性评分（0-10分，从脆弱角度）

关键概念：最弱假设 = 整个链条的强度

假设1：25%
假设2：30%
假设3：20% ← 最弱的假设
假设4：25%

综合强度 = 20%（由最弱的假设决定）

评分：
- 最弱假设 > 50% → 1分（脆弱性低）
- 最弱假设 30-50% → 3分
- 最弱假设 10-30% → 5分
- 最弱假设 < 10% → 7-9分（极度脆弱）

加分（增加脆弱性）：
+ 假设间高度相关（一个失败，其他也失败）→ +1分
+ 管理层执行历史差 → +1分
+ "全或无"特征（无中间方案）→ +1分

最终评分：__/10
"""
```

**具体修改：**
- [ ] 在 prompt 开头添加"模型5脆弱性"声明
- [ ] 加入 4 种假设质疑方法的指导
- [ ] 添加脆弱性评分机制
- [ ] 重新评估 Bull 的概率估计

---

### Step 1.5：Fundamentals Analyst（1-1.5 天）

**当前状态：** ✓ 有财务分析，⚠️ 需要分离成两个评分（模型2+模型3）

**改动内容：**

```python
# 在 system_message 中添加

# 1. 模型声明
"""
🎯 你的角色：基本面分析员

你负责评估两个模型：
- MODEL 2：成本结构透明性
- MODEL 3：竞争格局监测

核心问题：
- 模型2："这个公司的单位经济学支持投资吗？"
- 模型3："竞争格局对我们有利吗？"
"""

# 2. 成本结构分析（新增）
"""
### 模型2：成本结构分析

关键指标：

1. 毛利率
   > 40% → 很健康
   30-40% → 健康
   20-30% → 还好
   < 20% → 有压力
   
   趋势：↑改善 vs ↓恶化？

2. 运营现金流
   正且增长 → 最佳
   正但下滑 → 需关注
   负 → 烧钱阶段（需多久才盈利？）

3. 单位经济学
   SaaS：LTV/CAC > 3？
   电商：单件利润 vs 成本？
   制造：产能利用率？

4. 管理层承诺
   成本控制计划是什么？
   具体行动？可信度？

成本结构评分（0-10分）：
- 基分：毛利率决定
- 加分：改善趋势、现金流、管理层信心
- 减分：恶化趋势、现金流坏化

最终评分：__/10
"""

# 3. 竞争格局分析（新增）
"""
### 模型3：竞争格局分析

关键指标：

1. 市场份额
   我们的份额：↑增加 / →稳定 / ↓下降？
   竞争对手的份额如何变化？
   新竞争者出现吗？

2. 竞争对手对比
   毛利率对比：我们 vs 竞争对手
   增长率对比：我们 vs 竞争对手
   债务对比：我们 vs 竞争对手

3. 产品竞争力
   新产品发布情况
   定价策略变化
   顾客反馈

4. 竞争信号等级
   L0：噪音（单一事件）
   L1：弱信号（重复出现）
   L2：强信号（行业转向）
   L3：行动信号（市场转移）
   L4：确认信号（长期转变）

竞争格局评分（0-10分）：
- 基分：市场份额决定
- 加分：竞争对手衰弱、新产品强
- 减分：新对手进入、价格战、份额下滑

最终评分：__/10
"""

# 4. 输出格式
"""
### 输出要求

1. 成本结构分析 → 评分__/10
2. 竞争格局分析 → 评分__/10  
3. Markdown 表格

格式：
指标 | 当前值 | 趋势 | 评分 | 与竞争对手对比
"""
```

**具体修改：**
- [ ] 在 system_message 开头分离"模型2"和"模型3"声明
- [ ] 添加成本结构分析框架和评分
- [ ] 添加竞争格局分析框架和评分
- [ ] 修改输出格式支持两个独立评分

---

## 📊 验证清单

完成 Phase 1 后，检查：

- [ ] Market Analyst - 输出格式包含"信号可信度评分 __/10"
- [ ] News Analyst - 输出包含"⚠️ 情绪峰值检测：YES/NO" 和"情绪评分 __/10"
- [ ] Bull Researcher - 输出包含假设链、综合概率和"假设链强度 __/10"
- [ ] Bear Researcher - 输出包含修正后的概率和"脆弱性评分 __/10"
- [ ] Fundamentals Analyst - 输出包含两个独立评分"成本结构 __/10" 和"竞争格局 __/10"

---

## 🎯 接下来

Phase 1 完成后，可以进入 Phase 2：
- 修改 Risk Manager 接收 5 个评分（或 6 个，如果分离成本结构和竞争）
- 计算加权平均
- 生成最终决策

要不要现在开始改 Market Analyst？

