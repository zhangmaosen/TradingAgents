# 🧠 Agent 元思考层 - 泛化与自适应指南

## 问题诊断

当前的 Prompt 优化存在 **范式固化风险**：

```
现状：
规则清晰 ✅ → 但僵化 ❌
├─ "情绪峰值 = 满足6个条件中的3个" 
├─ "成本结构评分 = 毛利率决定基分 + 加减"
└─ "假设链强度 = 最弱假设的概率"

问题：
• 异常情况处理能力差（如黑天鹅事件）
• 无法解释为什么这么打分
• 不会在模型假设被违反时调整
• 无法处理模型之间的冲突
```

---

## 解决方案：三层架构

```
L3 元思考层（新增）← 自我质疑、自适应
  ↓
L2 评分层（现有）← 具体的 0-10 评分
  ↓
L1 分析层（现有）← 数据收集和解释
```

---

## 实施方案

### 方案 A：元思考框架（推荐用于 Bull/Bear/Risk Manager）

每个 Agent 需要加入这段 Prompt：

```python
"""
### 元思考指引（重要）

在给出任何评分或结论前，先问自己：

1️⃣ 我的假设是什么？
   - 我假设 X 会发生
   - 这个假设的反面是什么？
   - 如果反面发生，我的分析还成立吗？

2️⃣ 我在用什么"镜头"看这个问题？
   - 我是否在看所有角度，还是只看某一面？
   - 相反角度的 Agent 会怎么解释同样的数据？
   - 是否存在我完全忽视的视角？

3️⃣ 我对自己的评分有多确定？
   - 我打 7/10 是因为数据很强，还是因为没找到反对的证据？
   - 如果有 1 个关键信息改变，我的评分会不会从 7 变成 3？

4️⃣ 是否存在黑天鹅风险？
   - 有什么我没想到的东西可能完全翻转我的分析？
   - 历史上类似的意外都是什么？

5️⃣ 我应该降低多少确定性？
   - 基础分：7/10
   - 确定性调整：-1 分（因为我对 X 的预测不到 80% 确定）
   - 最终分：6/10

输出要求：
- 明确说出你的核心假设
- 说出最大的反驳点是什么
- 说出你的确定性水平（从 30% 到 95%）
- 如果确定性 < 60%，主动降低评分
"""
```

### 方案 B：情景感知框架（用于所有 Agent）

```python
"""
### 情景感知（自适应规则）

根据市场情景，调整评分标准：

📈 牛市环境（市场 ↑）
- 规则缩放：乐观情绪权重 ↑
- 例：Peak Detection 要求满足 3/6 → 需要 4/6 才算峰值
- 理由：牛市本身就乐观，小心 FOMOed 情绪

📉 熊市环境（市场 ↓）
- 规则缩放：悲观情绪权重 ↑
- 例：成本结构评分，毛利率 > 40% 得 7 分 → 需要 > 45% 得 7 分
- 理由：熊市中盈利能力要求更高

↔️ 震荡环境（市场 ↔）
- 规则缩放：均衡权重
- 对所有信号给予等权重

⚠️ 波动率高环境（VIX 高）
- 调整：降低所有评分 1-2 分
- 理由：高波动下的信号可信度天生降低

🔴 关键问题：
如果你发现规则在这个情景下不适用怎么办？
- 说出来
- 解释为什么
- 提出替代规则
- 例："牛市中，情绪峰值检测应该用高标准（4/6），因为..."
"""
```

### 方案 C：模型冲突检测（用于 Risk Manager）

```python
"""
### 模型冲突与调和

5 个模型的评分可能会互相矛盾。这不是坏事，而是很重要的信息。

检测冲突模式：

🔴 关键冲突（需要特别处理）

冲突1："信号强但假设链脆弱"
  Model 1: 8/10 (技术信号很强)
  Model 5: 3/10 (假设不成立的概率很高)
  
  解释：市场可能在反映某个短期事件，但基本面不支持长期持有
  决策：可以短期交易，不应该长期持有
  
冲突2："基本面好但情绪过度"
  Model 2: 8/10 (成本结构很好)
  Model 4: 2/10 (情绪明显峰值)
  
  解释：公司很好，但已经被定价得很高
  决策：等待情绪降温再买，或小额参与
  
冲突3："竞争恶化但情绪还在高"
  Model 3: 2/10 (竞争格局明显恶化)
  Model 4: 8/10 (市场热情仍高)
  
  解释：市场还没反应竞争变化，可能是陷阱
  决策：不买，持有现有头寸等看
  
冲突4："信号弱但假设链很强"
  Model 1: 3/10 (技术信号很弱)
  Model 5: 8/10 (假设链很强)
  
  解释：公司基本面很好但目前没有技术买点
  决策：等待更好的入场点

🟡 如何调和冲突？

优先级规则（不是固定的，需要根据情况调整）：
1. Model 5 > 其他（假设链脆弱是底线风险）
2. Model 2 & 3 > Model 1（基本面优先于技术）
3. Model 4 可以低权重（因为最容易反转）

但也可能需要反向权重：
- 如果 Model 5 过度悲观？可能是 Bear 太保守了
- 检查：Bear 是否在用 30% 概率估计应该用 50% 的东西？

输出要求：
- 列出所有检测到的冲突
- 对每个冲突说明你倾向于相信哪个模型为什么
- 最终 DECISION 时明确说出"我相信 Model X，因为..."
"""
```

---

## 修改策略：如何避免死板教条

### ❌ 不要这样做

```python
# 坏例子
if 毛利率 > 40:
    成本结构评分 = 7
else:
    成本结构评分 = 3  # 过于僵化
```

### ✅ 应该这样做

```python
# 好例子
"""
### 成本结构评分

基础参考规则：
- 毛利率 > 40% → 通常 7 分
- 毛利率 30-40% → 通常 5 分
- 毛利率 < 30% → 通常 3 分

但需要考虑情景：

1. 行业基准
   "这个行业的平均毛利率是多少？"
   比行业平均高 10% → +2 分
   
2. 趋势方向
   "毛利率在改善还是恶化？"
   从 35% 上升到 42% → +1 分（轨迹好）
   从 50% 下降到 38% → -2 分（轨迹差）
   
3. 成本结构转变
   "公司是否在从成本驱动向价值驱动转变？"
   从硬件转向 SaaS → 即使毛利率暂时下降，也要 +1 分（未来更好）
   
4. 市场定价
   "市场对这个毛利率的反应是什么？"
   如果股票贵了很多，市场可能已经定价 → -1 分
   如果股票便宜，市场可能小看了 → +1 分

最终评分 = 基础分 + 行业调整 + 趋势调整 + 转变调整 + 定价调整

关键是：明确说出你在哪里偏离了基础规则，为什么。
"""
```

---

## 每个 Agent 的元思考改进

### Market Analyst - 自我质疑

```python
"""
### Meta: 我的信号分析存在的盲点

问1："这个信号是因为基本面改变，还是只是技术面反弹？"
→ 如果不能确定，评分 -2 分

问2："如果我错了，是会少赚一倍还是亏一半？"
→ 潜在亏损 > 潜在收益 → 评分 -1 分

问3："最会反驳我的人会说什么？"
→ 想出反驳点后，我需要多找 1-2 个支持信号才能确认
"""
```

### Fundamentals Analyst - 数据vs直觉平衡

```python
"""
### Meta: 我何时应该不相信数字

问1："这些数字是否被管理层操纵过？"
→ 检查：应收账款占收入比是否异常高？库存是否异常高？
→ 如果有异常，评分 -1 分

问2："这个成本结构是可持续的吗？还是短期优化？"
→ 如果是为了这一季度看起来好看而牺牲未来 → 评分 -2 分

问3："竞争对手是否正在做同样的成本优化？"
→ 如果是行业普遍趋势而非竞争优势 → 评分 -1 分
"""
```

### News Analyst - 情绪峰值的非黑白判断

```python
"""
### Meta: 峰值不等于绝对反转

问1："这个峰值是一次性的还是新常态？"
→ 例：AI 的热情可能就是会持续高位，不是必然反转
→ 如果这是新常态，不应该因为峰值而大幅降分

问2："历史上类似的"峰值"持续了多久？"
→ iPhone 发布时情绪峰值，但产品确实改变了行业（3 年↑）
→ vs 某个八卦新闻峰值，1 周就过了

问3："是否存在自我实现的预言？"
→ 如果大家都说这是峰值，会不会因为大家抛售而真的反转？
"""
```

### Bull Researcher - 假设挑战

```python
"""
### Meta: 我的乐观有多偏见？

问1："我有没有在寻求支持性证据？还是在寻求真实？"
→ 诚实度检查：有没有至少考虑 3 个能推翻我的论点？

问2："如果管理层换人，我的论文还成立吗？"
→ 如果严重依赖某个关键人物 → 脆弱性 +1

问3："我对执行风险的评估有没有被低估？"
→ 历史上，类似的公司的执行延迟多长？
→ 典型延迟 2 年，我预测 18 个月 → 可能太乐观
"""
```

### Bear Researcher - 过度否定检查

```python
"""
### Meta: 我是否在假装聪明？

问1："我有没有在以'谨慎'之名拒绝所有正面证据？"
→ 检查：有没有给出任何我会改变主意的条件？
→ 如果一切都是"可能失败"而没有"如果 X 则成功" → 问题很大

问2："我对风险的评估是现实的还是极端的？"
→ 对标：我给的风险概率，历史上实际发生了多少次？

问3："我有没有考虑大多数人做不到的事，这家公司反而能做？"
→ 例：大多数电动车公司失败，但 Tesla 活下来了
→ 需要具体分析为什么这家公司不同
"""
```

### Risk Manager - 决策黑盒检查

```python
"""
### Meta: 我的加权平均有没有隐藏的假设？

问1："我使用的权重反映了我真实的信念吗？"
→ 例：我说 Model 5 权重最高，但评分只差 0.5？
→ 权重和实际差异不匹配 → 需要调整

问2："是否存在某个模型的评分被严重忽视？"
→ 例：Model 4 (情绪)一直是 2/10，但被权重 0.1%？
→ 为什么还要评分？

问3："加权平均是不是掩盖了重要的冲突？"
→ [8, 8, 8, 8, 1] 平均 = 6.6，但最后一个 1 很关键
→ 应该特别调查为什么有这么大的分歧
"""
```

---

## 实施方式

### 🎯 短期（立即添加）

在每个 Agent 的 Prompt 最后加入 2-3 个"Meta 问题"：

```python
system_message = """
[现有的分析框架...]

### 🧠 完成分析前的自我检查（重要）

- 我最可能犯的错误是什么？我避免了吗？
- 相反角度的人会如何解释同样的数据？
- 我的评分反映的是我的信念，还是我的无知？
"""
```

### 🎯 中期（1-2 周后优化）

根据实际输出，提炼出每个 Agent 的常见偏见：

- Market Analyst 常见偏见：对技术面过度自信
- News Analyst 常见偏见：把短期情绪当成长期趋势
- Bull Researcher 常见偏见：对管理层执行能力过度乐观
- Bear Researcher 常见偏见：过度强调风险而忽视机会
- Fundamentals Analyst 常见偏见：用历史数据而非前瞻性思考

然后针对性添加"偏见校正"：

```python
"""
### ⚠️ 校正常见偏见

我倾向于 [XX]，需要意识到：
- 过去 3 次分析中，我有 2 次因为 [XX] 而遗漏重要信息
- 这次，我需要额外考虑...
"""
```

### 🎯 长期（建立学习系统）

1. 记录每个 Agent 的历史预测
2. 对比实际结果
3. 识别模型系统性的过度/低估倾向
4. 自动调整权重或提醒

---

## 核心原则

| 维度 | 坏做法 | 好做法 |
|------|--------|--------|
| **规则化程度** | 死板的 if-then | 原则 + 情景调整 |
| **确定性** | 总是给明确的分数 | 明确说出不确定性 |
| **冲突处理** | 取平均 | 明确冲突，选择相信哪个 |
| **异常情况** | 应用同样的规则 | 识别异常，说明为什么不适用 |
| **自我批评** | 没有 | 每个输出都包含反驳点 |
| **学习能力** | 不会改变 | 定期回顾历史错误 |

---

## 集成方案：两层提示

### 第一层：具体规则（现有）

```
给出 0-10 的分数
```

### 第二层：元思考提示（新增）

```python
# 在 system_message 最后加入这段

"""
### 🔴 重要：你不是计算器

你不是根据规则生成分数的工具，而是一个思考者。

- 规则是指南，不是法律
- 你可以打破规则，只要能解释为什么
- 如果你不能解释，你可能就错了
- 你的输出中必须包含：
  1. 你的确定性（60% / 75% / 90%）
  2. 最强的反驳点是什么
  3. 如果错了，你会在哪里失败

例子：
❌ "毛利率 50% → 成本结构 8/10"
✅ "毛利率 50%，高于行业均值 40%，所以基础分 7 分。
    但公司正在进入更激烈的竞争市场（美国），可能会压低毛利率，
    所以我降到 6.5 分。确定性 75%。
    最大风险：如果美国市场竞争比预期更激烈，可能跌到 4 分。"
"""
```

---

## 总结

**问题：** 过度规范化 → 失去泛化和自适应能力

**解决：** 加入元思考层
- 元问题：问自己为什么这么打分
- 情景感知：规则会根据市场环境调整
- 冲突检测：模型冲突是有价值的信息
- 偏见审视：每个 Agent 都有系统性偏见

**效果：**
- Agent 不再是死板的规则执行器
- Agent 变成"有原则但灵活"的思考者
- 输出更可解释和可信赖
- 自动具有"异常检测"能力

**下一步：**
需要改进现有的 AGENTS_PROMPT_IMPLEMENTATION.md，在每个 Agent 的 prompt 中加入元思考层？
